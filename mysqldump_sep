#!/bin/bash
# mysqldump_sep
#
# :Author:   Jordi Funollet <jordi.f@ati.es>

# CHANGELOG
# 2005-09-28
# - Initial version.
# 2006-03-31 19:37:55
# - Backup all DBs.
# - Don't use a config file. Use ~/.my.cfg
# - Use date and time on filename.
# - Change default value for $BACKUPDIR.
#
# TODO:
# - check_conf_file ()
# - broader pre_check


####  Generic library  ####
# Just warn and continue.
function warn () { echo "[`basename $0`] warning: $*" ; } ;
# Warn and exit.
function error () { echo "[`basename $0`] error: $*" ; exit 1 ; } ;
# Checks var has value.
function test_var () { [ -z "$2" ] && warn "$1 void." ; } ;
###########################


####  Custom config  ####
# Destination directory.
BACKUPDIR='/home/backups/mysql'

# Backup all DBs.
if [ -z "$DDBB" ] ; then
    DDBB=`mysqlshow | awk '{print $2}' | tail +4 `
fi
#########################


function pre_checks () {
    test_var DDBB $DDBB
    test_var BACKUPDIR $BACKUPDIR
}    


function main () {
    umask 0077
    
    # Dump each database
    for db in $DDBB ; do
	FNAME="$BACKUPDIR/mysql.$db.`date +%F.%X`.mysql"
	mysqldump --opt $db > $FNAME || warn "problems dumping $db"
	# Compress if has contents, warn else.
	[ -s $FNAME ] && gzip -f $FNAME || warn "$FNAME void."
    done

    exit 0
}


pre_checks
main   